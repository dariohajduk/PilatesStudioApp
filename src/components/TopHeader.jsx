import React, { useEffect, useState } from "react";
import { collection, getDocs } from "firebase/firestore";
import { db } from "../services/firebase";

/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
/**
 * TODO: תאר את הפונקציה TopHeader
 */
const TopHeader = ({ title, userData, allClasses }) => {
  const [weeklyCount, setWeeklyCount] = useState(0);
  const [monthlyCount, setMonthlyCount] = useState(0);
  const [uniqueParticipantsCount, setUniqueParticipantsCount] = useState(0);
  const [userCount, setUserCount] = useState(0);
  const [instructorCount, setInstructorCount] = useState(0);

  const isInstructor = userData?.isInstructor === true;
  const isAdmin = userData?.isAdmin === true;

  useEffect(() => {
    const normalizePhone = (phone) => phone?.replace(/\D/g, "");

    const fetchStats = async () => {
      if (!isInstructor || !userData?.phone || !Array.isArray(allClasses)) return;

      const currentPhone = normalizePhone(userData.phone);
      const now = new Date();

      // תחילת השבוע - ראשון
      const startOfWeek = new Date(now);
      startOfWeek.setDate(now.getDate() - now.getDay());
      startOfWeek.setHours(0, 0, 0, 0);

      // סוף השבוע - שבת
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(endOfWeek.getDate() + 6);
      endOfWeek.setHours(23, 59, 59, 999);

      // תחילת החודש (חודש נוכחי)
      const year = now.getFullYear();
      const startOfMonth = new Date(year, now.getMonth(), 1);
      startOfMonth.setHours(0, 0, 0, 0);

      // סוף החודש (יום אחרון בחודש)
      const endOfMonth = new Date(year, now.getMonth() + 1, 0);
      endOfMonth.setHours(23, 59, 59, 999);

      // שיעורים בשבוע הנוכחי
      const classesThisWeek = allClasses.filter((cls) => {
        if (!cls.instructorId || !cls.date || !cls.time) return false;
        const instructorPhone = normalizePhone(cls.instructorId);
        if (instructorPhone !== currentPhone) return false;
        const clsDate = new Date(`${cls.date.split("/").reverse().join("-")}T${cls.time}`);
        return clsDate >= startOfWeek && clsDate <= endOfWeek;
      });
      setWeeklyCount(classesThisWeek.length);

      // שיעורים בחודש הנוכחי
      const classesThisMonth = allClasses.filter((cls) => {
        if (!cls.instructorId || !cls.date || !cls.time) return false;
        const instructorPhone = normalizePhone(cls.instructorId);
        if (instructorPhone !== currentPhone) return false;
        const clsDate = new Date(`${cls.date.split("/").reverse().join("-")}T${cls.time}`);
        return clsDate >= startOfMonth && clsDate <= endOfMonth;
      });
      setMonthlyCount(classesThisMonth.length);

      // חישוב משתתפים ייחודיים בחודש
      if (classesThisMonth.length === 0) {
        setUniqueParticipantsCount(0);
        return;
      }
      const classIds = classesThisMonth.map((cls) => cls.id);

      try {
        const bookingsSnap = await getDocs(collection(db, "bookings"));
        const allBookings = bookingsSnap.docs.map((doc) => doc.data());

        const relevantBookings = allBookings.filter((b) => classIds.includes(b.classId));
        const uniqueUserIds = [...new Set(relevantBookings.map((b) => b.userId))];

        setUniqueParticipantsCount(uniqueUserIds.length);
      } catch (error) {
        console.error("שגיאה בטעינת ההזמנות:", error);
        setUniqueParticipantsCount(0);
      }
    };

    fetchStats();
  }, [isInstructor, allClasses, userData]);

  useEffect(() => {
    const fetchUserStats = async () => {
      try {
        const usersSnap = await getDocs(collection(db, "Users"));
        const users = usersSnap.docs.map((doc) => doc.data());

        const nonAdminUsers = users.filter((u) => u.isAdmin !== true);
        const instructors = nonAdminUsers.filter((u) => u.isInstructor === true);
        const regularUsers = nonAdminUsers.filter((u) => u.isInstructor !== true);

        setUserCount(regularUsers.length);
        setInstructorCount(instructors.length);
      } catch (error) {
        console.error("שגיאה בטעינת נתוני משתמשים:", error);
      }
    };

    if (isAdmin) {
      fetchUserStats();
    }
  }, [isAdmin]);

  return (
    <header className="bg-blue-600 text-white px-4 py-2 shadow-md flex justify-between items-center flex-wrap gap-2">
      <h1 className="text-xl font-bold">{title}</h1>

      {userData && isInstructor && (
        <div className="bg-white text-blue-600 font-semibold py-1 px-4 rounded-full text-sm select-none whitespace-nowrap"
          style={{ boxShadow: "0 0 6px rgba(0,0,0,0.25)" }}
        >
          מדריך | {weeklyCount} שיעורים השבוע | {monthlyCount} בחודש | {uniqueParticipantsCount} משתתפים
        </div>
      )}

      {userData && isAdmin && (
        <div className="bg-white text-blue-600 font-semibold py-1 px-4 rounded-full text-sm select-none whitespace-nowrap"
          style={{ boxShadow: "0 0 6px rgba(0,0,0,0.25)" }}
        >
          מנהל | {userCount} לקוחות | {instructorCount} מדריכים
        </div>
      )}

      {userData && !isInstructor && !isAdmin && (
        <div className="bg-red-500 text-white font-semibold py-1 px-3 rounded-lg text-sm select-none whitespace-nowrap">
          נשארו לך {userData.remainingClasses || 0} מתוך {userData.totalClasses || 0} שיעורים
        </div>
      )}
    </header>
  );
};

export default TopHeader;